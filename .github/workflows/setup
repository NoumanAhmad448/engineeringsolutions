name: Run Laravel Tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
permissions:
  contents: write # Allows the workflow to push changes
  actions: read # Allows reading action logs
  pull-requests: write # Enables PR creation and updates

jobs:
  setup_lyskills:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        laravel: [9.*, 10.*] # Laravel versions to test
        php: [8.1, 8.2, 8.3] # PHP versions to test

        commit_msg: ["Fixes coding style"]
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_DATABASE: test_db
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        volumes:
          - ./my.cnf:/etc/mysql/my.cnf # Mount the custom config file

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Fetch all history for accurate results

      - name: Setup PHP
        uses: shivammathur/setup-php@21e092a3e0c2fabb77bf641337eced34a4bcd3cc
        with:
          php-version: ${{ matrix.php }}
          extensions: json, dom, curl, libxml, mbstring, bz2, fileinfo, gd, gettext, mbstring, exif, mysqli, pdo_mysql redis
          tools: pint:1.16.1, phpdoc, composer:2.4.4
          coverage: none

      - name: Create additional databases
        run: |
          mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE IF NOT EXISTS ${{secrets.DB_DATABASE}};
          CREATE DATABASE IF NOT EXISTS ${{secrets.DB_TESTING_DATABASE}};
          CREATE DATABASE IF NOT EXISTS ${{secrets.DB_Laravel}};
          "
          mysql -h 127.0.0.1 -u root -proot -e "SHOW DATABASES;"
          # CREATE USER 'username'@'%' IDENTIFIED BY 'password';
          # GRANT ALL PRIVILEGES ON database_name.* | *.* TO 'username'@'%';

      - name: Set up Environment File
        run: |
          cp .env.testing.example .env

          echo "DB_CONNECTION=${{secrets.DB_CONNECTION}}"  >> .env
          echo "DB_HOST=${{secrets.DB_HOST}}"  >> .env
          echo "DB_PORT=${{secrets.DB_PORT}}"  >> .env
          echo "DB_DATABASE=${{secrets.DB_DATABASE}}"  >> .env
          echo "DB_USERNAME=${{secrets.DB_USERNAME}}"  >> .env
          echo "DB_PASSWORD=${{secrets.DB_PASSWORD}}"  >> .env
          echo "MAIL_HOST=${{secrets.MAIL_HOST}}"  >> .env
          echo "MAIL_USERNAME=${{secrets.MAIL_USERNAME}}"  >> .env
          echo "MAIL_PASSWORD=${{secrets.MAIL_PASSWORD}}"  >> .env
          echo "MAIL_FROM_ADDRESS=${{secrets.MAIL_FROM_ADDRESS}}"  >> .env
          echo "AWS_ACCESS_KEY_ID=${{secrets.AWS_ACCESS_KEY_ID}}"  >> .env
          echo "AWS_SECRET_ACCESS_KEY=${{secrets.AWS_SECRET_ACCESS_KEY}}"  >> .env
          echo "AWS_DEFAULT_REGION=${{secrets.AWS_DEFAULT_REGION}}"  >> .env
          echo "AWS_BUCKET=${{secrets.AWS_BUCKET}}"  >> .env
          echo "NOCAPTCHA_SITEKEY=${{secrets.NOCAPTCHA_SITEKEY}}"  >> .env
          echo "NOCAPTCHA_SECRET=${{secrets.NOCAPTCHA_SECRET}}"  >> .env
          echo "GOOGLE_APP_KEY=${{secrets.GOOGLE_APP_KEY}}"  >> .env
          echo "GOOGLE_SECURITY_KEY=${{secrets.GOOGLE_SECURITY_KEY}}"  >> .env
          echo "FACEBOOK_APP_KEY=${{secrets.FACEBOOK_APP_KEY}}"  >> .env
          echo "FACEBOOK_SECURITY_KEY=${{secrets.FACEBOOK_SECURITY_KEY}}"  >> .env
          echo "LINKEDIN_APP_KEY=${{secrets.LINKEDIN_APP_KEY}}"  >> .env
          echo "LINKEDIN_SECURITY_KEY=${{secrets.LINKEDIN_SECURITY_KEY}}"  >> .env
          echo "STRIPE_KEY=${{secrets.STRIPE_KEY}}"  >> .env
          echo "STRIPE_SECRET=${{secrets.STRIPE_SECRET}}"  >> .env
          echo "PAYPAL_SANDBOX_CLIENT_ID=${{secrets.PAYPAL_SANDBOX_CLIENT_ID}}"  >> .env
          echo "PAYPAL_SANDBOX_CLIENT_SECRET=${{secrets.PAYPAL_SANDBOX_CLIENT_SECRET}}"  >> .env
          echo "PAYPAL_LIVE_CLIENT_ID=${{secrets.PAYPAL_LIVE_CLIENT_ID}}"  >> .env
          echo "PAYPAL_LIVE_CLIENT_SECRET=${{secrets.PAYPAL_LIVE_CLIENT_SECRET}}"  >> .env
          echo "DEBUG_JS=${{secrets.DEBUG_JS}}"  >> .env
          echo "AWS_URL=${{secrets.AWS_URL}}"  >> .env
          echo "NO_REPLY_EMAIL_PASS=${{secrets.NO_REPLY_EMAIL_PASS}}"  >> .env
          echo "DB_TESTING_DATABASE=${{secrets.DB_TESTING_DATABASE}}"  >> .env
          echo "DB_Laravel=${{secrets.DB_Laravel}}"  >> .env
          echo "AWS_ENDPOINT=${{secrets.AWS_ENDPOINT}}"  >> .env
          echo "CONTACT_US_MAIL=${{secrets.CONTACT_US_MAIL}}"  >> .env
          echo "SLACK_URL=${{secrets.SLACK_URL}}"  >> .env
          echo "SLACK_CHANNEL=${{secrets.SLACK_CHANNEL}}"  >> .env
          echo "SLACK_USR_NAM=${{secrets.SLACK_USR_NAM}}"  >> .env

          cp .env .env.testing
          echo "DB_DATABASE=${{secrets.DB_TESTING_DATABASE}}"  >> .env.testing

      - name: Creating essential directoires
        run: |
          sudo mkdir -p $GITHUB_WORKSPACE/storage/app
          sudo mkdir -p $GITHUB_WORKSPACE/bootstrap/cache
          sudo mkdir -p $GITHUB_WORKSPACE/storage/framework/cache
          sudo mkdir -p $GITHUB_WORKSPACE/storage/framework/sessions
          sudo mkdir -p $GITHUB_WORKSPACE/storage/framework/views
          sudo mkdir -p $GITHUB_WORKSPACE/storage/logs

      - name: File permission
        run: yes | sudo chmod -R 777 $GITHUB_WORKSPACE/storage/ $GITHUB_WORKSPACE/bootstrap/cache

      - name: Show file structure
        run: sudo ls -l $GITHUB_WORKSPACE

      - name: check user
        run: whoami

      - name: Set folder ownership to current user
        run: sudo chown -R $(whoami):$(whoami) $GITHUB_WORKSPACE/storage/ $GITHUB_WORKSPACE/bootstrap/cache

      - name: installing composer
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-cache

      - name: Run Pint for code styling
        run: pint --config pint.json

      - name: Checking databse credentials
        run: |
          echo "DB_CONNECTION=${{secrets.DB_CONNECTION}}"
          echo "DB_HOST=${{secrets.DB_HOST}}"
          echo "DB_PORT=${{secrets.DB_PORT}}"
          echo "DB_DATABASE=${{secrets.DB_DATABASE}}"
          echo "DB_USERNAME=${{secrets.DB_USERNAME}}"
          echo "DB_PASSWORD=${{secrets.DB_PASSWORD}}"

      - name: Create Symlink (Linux/macOS)
        run: ln -s $GITHUB_WORKSPACE/public $GITHUB_WORKSPACE/storage/public
        if: runner.os != 'Windows'

      - name: Create Symlink (Windows)
        run: cmd.exe /c mklink /D $GITHUB_WORKSPACE/public $GITHUB_WORKSPACE/storage/public
        if: runner.os == 'Windows'

      - name: Verify Symlink
        run: ls -l $GITHUB_WORKSPACE/public

      - name: Running migrations Tests
        run: yes | php artisan migrate --force

      - name: Running Cache
        run: |
          php artisan cache:clear && php artisan config:clear && php artisan route:clear
          php artisan view:clear && php artisan event:clear && php artisan clear-compiled
          php artisan optimize:clear
          php artisan cache:forget spatie.permission.cache

      - name: Checking Laravel Health
        run: php artisan health:check --no-notification

      - name: Run Tests
        run: |
          APP_ENV=testing php artisan test --group global-tests
        continue-on-error: true # âœ… Allows pipeline to continue even if tests fail
